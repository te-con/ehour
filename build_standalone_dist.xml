<project xmlns:artifact="antlib:org.apache.maven.artifact.ant"
         name="eHourStandaloneDist" default="archive" basedir=".">
    <description>
        Builds eHour standalone dist file (don't mention Maven's assembly plugin..)
        Before running this script eHour must be compiled with mvn clean install -Pprod -Pstandalone
    </description>

    <path id="maven-ant-tasks.classpath" path="lib/maven-ant-tasks-2.1.1.jar"/>
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
             uri="antlib:org.apache.maven.artifact.ant"
             classpathref="maven-ant-tasks.classpath"/>

    <artifact:pom id="pom" file="eHour-standalone/pom.xml">
        <profile id="standalone"/>
        <profile id="prod"/>
    </artifact:pom>

    <property name="version" value="${pom.version}"/>

    <property name="base" location="dist"/>
    <property name="dist" location="${base}/standalone/ehour-${version}"/>
    <property name="lib" location="${dist}/lib"/>
    <property name="app" location="${dist}/app"/>
    <property name="bin" location="${dist}/bin"/>
    <property name="conf" location="${dist}/conf"/>
    <property name="i18n" location="${dist}/resources/i18n"/>

    <target name="init" depends="clean">
        <echo message="Make sure you compiled with mvn clean install -Pprod -Pstandalone before running this script"/>

        <mkdir dir="${basedir}"/>
        <mkdir dir="${dist}"/>
        <mkdir dir="${lib}"/>
        <mkdir dir="${app}"/>
        <mkdir dir="${bin}"/>
        <mkdir dir="${conf}"/>
        <mkdir dir="${dist}/log"/>
        <mkdir dir="${i18n}"/>
	<mkdir dir="${dist}/db"/>
    </target>

    <target name="dist" depends="init">
        <!-- Exploded WAR excl dependencies -->
        <copy todir="${app}">
            <fileset dir="eHour-web/src/main/webapp" excludes=".svn"/>
        </copy>

        <!-- WAR dependencies -->
        <artifact:dependencies filesetid="dependency.fileset" pomRefid="pom" scopes="compile, runtime"/>

        <copy todir="${lib}">
            <fileset refid="dependency.fileset"/>
            <fileset file="eHour-standalone/target/eHour-standalone-${version}.jar"/>
            <mapper type="flatten"/>
        </copy>

        <!-- Tanuki wrapper platform binaries -->
        <copy todir="${bin}">
            <fileset dir="assembly/standalone/bin" excludes=".svn"/>
        </copy>

        <chmod type="file" perm="ugo+rx">
            <fileset dir="${bin}/">
                <include name="**/*.sh"/>
                <include name="**/wrapper"/>
            </fileset>
        </chmod>

        <!-- Construct conf dir -->
        <copy todir="${conf}">
            <fileset dir="assembly/standalone/conf" excludes=".svn"/>
        </copy>

        <copy todir="${conf}">
            <fileset dir="assembly/common/conf" excludes=".svn"/>
        </copy>

        <!-- Translations -->
        <copy todir="${i18n}">
            <fileset dir="eHour-wicketweb/src/dist/i18n" excludes=".svn"/>
        </copy>

        <!-- License, readme, install instructions, etc -->
        <copy todir="${dist}">
            <fileset dir="assembly/common/txt" excludes=".svn"/>
            <fileset dir="assembly/standalone/txt" excludes=".svn"/>
            <filterset>
                <filter token="VERSION" value="${version}"/>
            </filterset>
        </copy>
    </target>

    <target name="archive" depends="dist">
        <!-- to preserve file permissions, use native zip -->
        <echo>Building zip: ${base}/ehour-${version}-standalone.zip</echo>

        <exec executable="zip" dir="${dist}/..">
            <arg value="-qR"/>
            <arg value="${base}/ehour-${version}-standalone.zip"/>
            <arg value="*"/>
        </exec>
    </target>

    <target name="clean">
        <delete dir="${dist}"/>
    </target>

</project>

