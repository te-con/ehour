<project xmlns:artifact="antlib:org.apache.maven.artifact.ant"
         name="eHourWarDist" default="archive" basedir=".">
    <description>
        Builds eHour WAR dist file (don't mention Maven's assembly plugin..)
        Before running this script eHour must be compiled with mvn clean install -Pprod -Pwar
    </description>

    <path id="maven-ant-tasks.classpath" path="lib/maven-ant-tasks-2.1.1.jar"/>
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
             uri="antlib:org.apache.maven.artifact.ant"
             classpathref="maven-ant-tasks.classpath"/>

    <artifact:pom id="pom" file="pom.xml"/>

    <property name="version" value="${pom.version}"/>

    <property name="base" location="dist"/>
    <property name="dist" location="${base}/war/ehour-${version}"/>
    <property name="app" location="${dist}/app"/>
    <property name="conf" location="${dist}/conf"/>
    <property name="sql" location="${dist}/sql"/>
    <property name="tomcat" location="${dist}/tomcat"/>
    <property name="i18n" location="${dist}/resources/i18n"/>

    <target name="init" depends="clean">
        <echo message="Make sure you compiled with mvn clean install -Pprod -Pwar before running this script"/>

        <mkdir dir="${basedir}"/>
        <mkdir dir="${dist}"/>
        <mkdir dir="${app}"/>
        <mkdir dir="${conf}"/>
        <mkdir dir="${dist}/log"/>
        <mkdir dir="${i18n}"/>
        <mkdir dir="${sql}"/>
        <mkdir dir="${sql}/mysql"/>
        <mkdir dir="${sql}/postgresql"/>
        <mkdir dir="${tomcat}"/>
    </target>

    <target name="dist" depends="init">
        <!-- WAR incl dependencies -->
        <copy file="eHour-web/target/eHour-web-${version}.war" tofile="${app}/ehour-${version}.war"/>

        <!-- Construct conf dir -->
        <copy todir="${conf}">
            <fileset dir="assembly/war/conf" excludes=".svn"/>
        </copy>

        <copy todir="${conf}">
            <fileset dir="assembly/common/conf" excludes=".svn"/>
        </copy>


        <!-- Translations -->
        <copy todir="${i18n}">
            <fileset dir="eHour-wicketweb/src/dist/i18n" excludes=".svn"/>
        </copy>

        <!-- License, readme, install instructions, etc -->
        <copy todir="${dist}">
            <fileset dir="assembly/common/txt" excludes=".svn"/>
            <fileset dir="assembly/war/txt" excludes=".svn"/>
            <filterset>
                <filter token="VERSION" value="${version}"/>
            </filterset>
        </copy>

        <!-- SQL DDL scripts -->
        <copy todir="${sql}/mysql">
            <fileset dir="eHour-persistence-mysql/src/sql" excludes=".svn"/>
        </copy>

        <copy todir="${sql}/postgresql">
            <fileset dir="eHour-persistence-postgresql/src/sql" excludes=".svn"/>
        </copy>

        <!-- Tomcat config -->
        <copy todir="${tomcat}">
            <fileset dir="assembly/war/tomcat" excludes=".svn"/>
            <filterset>
                <filter token="VERSION" value="${version}"/>
            </filterset>
        </copy>
    </target>

    <target name="archive" depends="dist">
        <zip destfile="${base}/ehour-${version}-war.zip" basedir="${dist}/.."/>
    </target>

    <target name="clean">
        <delete dir="${dist}"/>
    </target>

</project>

